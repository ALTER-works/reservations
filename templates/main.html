<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Выбор этажа и бронирование</title>
  <style>
    /* Ваши стили (без изменений) */
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      background-color: #121212;
      color: #eee;
    }
    #top-bar {
      height: 50px;
      background: #1e1e1e;
      display: flex;
      align-items: center;
      padding: 0 20px;
      color: #eee;
      user-select: none;
    }
    #avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #444;
      margin-right: 20px;
      flex-shrink: 0;
    }
    #top-bar button {
      background: #2c2c2c;
      border: none;
      color: #eee;
      padding: 6px 12px;
      margin-left: 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #top-bar button:hover {
      background-color: #007bff;
      color: white;
    }
    #main-container {
      flex: 1;
      display: flex;
      overflow: hidden;
      height: calc(100vh - 50px);
    }
    #left-panel {
      width: 300px;
      background: #1e1e1e;
      padding: 20px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 20px;
      overflow-y: auto;
      user-select: none;
    }
    .section {
      border: 1px solid #444;
      border-radius: 8px;
      background: #2c2c2c;
      color: #eee;
      cursor: pointer;
      user-select: none;
    }
    .section.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .section-header {
      padding: 10px 15px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }
    .section-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background: #1e1e1e;
      border-top: 1px solid #444;
    }
    .section.open .section-content {
      max-height: 400px;
      overflow-y: auto;
    }
    ul {
      list-style: none;
      margin: 0; padding: 0;
    }
    ul li {
      padding: 8px 15px;
      border-bottom: 1px solid #444;
      cursor: pointer;
      user-select: none;
    }
    ul li.disabled {
      color: #666;
      cursor: not-allowed;
    }
    ul li:hover:not(.disabled) {
      background: #007bff;
      color: white;
    }
    ul li.selected {
      background: #0056b3;
      color: white;
    }
    .subsection {
      border-top: 1px solid #444;
      padding: 10px 15px;
    }
    .subsection label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
      color: #ccc;
    }
    .subsection select {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #444;
      background: #2c2c2c;
      color: #eee;
      outline: none;
      box-sizing: border-box;
      cursor: pointer;
      margin-bottom: 10px;
    }
    .subsection select:disabled {
      background: #3a3a3a;
      color: #666;
      cursor: not-allowed;
    }
    #right-panel {
      flex: 1;
      background: #242229;
      position: relative;
      padding: 40px;
      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none;
      color: #eee;
      font-size: 1.2em;
      border-left: 1px solid #444;
      border-right: 1px solid #444;
    }
    #model-container {
      width: 90%;
      aspect-ratio: 1 / 1;
      background: #bbb;
      border-radius: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.3em;
      color: #444;
      user-select: none;
      position: relative;
      transition: background-color 0.3s ease;
    }
    #info-panel {
      width: 300px;
      background: #1e1e1e;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
      color: #eee;
      font-size: 0.9em;
      user-select: none;
      display: none;
      border-left: 1px solid #444;
    }
    #info-panel h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-weight: bold;
      border-bottom: 1px solid #444;
      padding-bottom: 5px;
    }
    #info-panel p {
      margin: 5px 0;
    }
    /* Кнопка бронирования */
    #reserve-btn {
      margin-top: 10px;
      padding: 10px;
      background-color: #007bff;
      border: none;
      color: white;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    #reserve-btn:disabled {
      background-color: #555;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

  <div id="top-bar">
    <div id="avatar" title="Аватар"></div>
    <button id="btn1">Кнопка 1</button>
    <button id="btn2">Кнопка 2</button>
    <button id="btn3">Кнопка 3</button>
    <button id="logoutBtn" style="margin-left:auto;">Выйти</button>
  </div>

  <div id="main-container">
    <div id="left-panel">
      <!-- Этажи -->
      <div class="section" id="section-floors">
        <div class="section-header">Этажи <span class="arrow">▼</span></div>
        <div class="section-content">
          <ul id="floor-list">
            // Здесь будет список доступных этажей
          </ul>
        </div>
      </div>

      <!-- Дата -->
      <div class="section disabled" id="section-date">
        <div class="section-header">Дата <span class="arrow">▼</span></div>
        <div class="section-content">
          <div class="subsection">
            <label for="year-select">Год</label>
            <select id="year-select" disabled></select>
          </div>
          <div class="subsection">
            <label for="month-select">Месяц</label>
            <select id="month-select" disabled></select>
          </div>
          <div class="subsection">
            <label for="day-select">День</label>
            <select id="day-select" disabled></select>
          </div>
          <div class="subsection">
            <label for="time-select">Время</label>
            <select id="time-select" disabled></select>
          </div>
        </div>
      </div>

      <!-- Аудитории -->
      <div class="section disabled" id="section-rooms">
        <div class="section-header">Аудитории <span class="arrow">▼</span></div>
        <div class="section-content">
          <ul id="room-list">
            // Здесь будет список аудиторий с этажа
          </ul>
        </div>
      </div>

      <!-- Кнопка бронирования -->
      <button id="reserve-btn" disabled>Забронировать</button>
    </div>

    <div id="right-panel">
      <div id="model-container">
        Выберите этаж слева, чтобы увидеть планировку
      </div>
    </div>

    <div id="info-panel">
      <!-- Информация по аудитории -->
    </div>
  </div>

  <script>
    // Секции этажей, даты и аудиторий
    const sectionFloors = document.getElementById('section-floors');
    const sectionDate = document.getElementById('section-date');
    const sectionRooms = document.getElementById('section-rooms');

    // Будущие списки этажей и комнат
    const floorList = document.getElementById('floor-list');
    const roomList = document.getElementById('room-list');
    let floorNum; // Для формирования этажа + отрисовки комнат

    // Переменные даты и времени
    const yearSelect = document.getElementById('year-select');
    const monthSelect = document.getElementById('month-select');
    const daySelect = document.getElementById('day-select');
    const timeSelect = document.getElementById('time-select');

    // Макет этажа + информация по комнате
    const modelContainer = document.getElementById('model-container');
    const infoPanel = document.getElementById('info-panel');

    // Кнопки
    const reserveBtn = document.getElementById('reserve-btn');
    const logoutBtn = document.getElementById('logoutBtn');

    // Данные из db (подгружаются через app.py)
    const users = {{ users | tojson }};
    const floors = {{ floors | tojson }};
    const reservations = {{ reservations | tojson }};

    // Расписание на текущий год + 3 следующих
    const currentYear = new Date().getFullYear();
    for(let y = currentYear; y <= currentYear + 3; y++) {
      const option = document.createElement('option');
      option.value = y;
      option.textContent = y;
      yearSelect.appendChild(option);
    }

    const monthNames = ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
    monthNames.forEach((m,i) => {
      const option = document.createElement('option');
      option.value = i+1;
      option.textContent = m;
      monthSelect.appendChild(option);
    });

    function daysInMonth(year, month) {
      return new Date(year, month, 0).getDate();
    }

    // Заполнение этажей
    function fillFloors() {
      floorList.innerHTML = '';
      Object.keys(floors).forEach(floorKey => {
        const floorNumber = floorKey.replace('floor_', '');
        const li = document.createElement('li');
        li.dataset.floor = floorKey; // хранить "floor_1", "floor_2"
        li.textContent = `Этаж ${floorNumber}`;
        floorList.appendChild(li);
      });
    }

    // Заполнение комнат на этаже
    function fillRooms(floorKey) {
      roomList.innerHTML = '';
      if (!floors[floorKey]) return;
      const auditories = floors[floorKey].auditories || [];
      if (auditories.length === 0) {
        const li = document.createElement('li');
        li.textContent = 'Аудиторий нет';
        li.classList.add('disabled');
        roomList.appendChild(li);
        return;
      }
      auditories.forEach(roomId => {
        const li = document.createElement('li');
        li.dataset.room = roomId; // Например, 's101'
        li.textContent = `Аудитория ${roomId.replace(/^s/, '')}`;
        roomList.appendChild(li);
      });
    }

    function updateDays() {
      const year = parseInt(yearSelect.value);
      const month = parseInt(monthSelect.value);
      if (!year || !month) {
        daySelect.innerHTML = '';
        daySelect.disabled = true;
        return;
      }
      const daysCount = daysInMonth(year, month);
      daySelect.innerHTML = '';
      for(let d=1; d<=daysCount; d++) {
        const option = document.createElement('option');
        option.value = d;
        option.textContent = d;
        daySelect.appendChild(option);
      }
      daySelect.disabled = false;
      daySelect.value = ''; // сброс
    }

    function fillTimeOptions() {
      timeSelect.innerHTML = '';
      for(let h=9; h<=20; h++) {
        const option = document.createElement('option');
        option.value = `${h}:00-${h+2}:00`;
        option.textContent = `${h}:00 - ${h+2}:00`;
        timeSelect.appendChild(option);
      }
      timeSelect.disabled = false;
      timeSelect.value = ''; // сброс
    }

    function toggleSection(section) {
      if (section.classList.contains('disabled')) return;
      section.classList.toggle('open');
    }

    sectionFloors.querySelector('.section-header').addEventListener('click', () => toggleSection(sectionFloors));
    sectionDate.querySelector('.section-header').addEventListener('click', () => toggleSection(sectionDate));
    sectionRooms.querySelector('.section-header').addEventListener('click', () => toggleSection(sectionRooms));

    floorList.addEventListener('click', e => {
      const li = e.target.closest('li');
      if (!li || li.classList.contains('disabled')) return;

      floorList.querySelectorAll('li').forEach(item => item.classList.remove('selected'));
      li.classList.add('selected');

      floorNum = li.dataset.floor;

      fillRooms(floorNum);

      sectionDate.classList.remove('disabled');
      sectionRooms.classList.remove('disabled');

      // sectionDate.classList.remove('open');
      // sectionRooms.classList.remove('open');

      yearSelect.disabled = false;
      monthSelect.disabled = false;
      daySelect.disabled = true;  // Заблокируем дни до выбора месяца и года
      timeSelect.disabled = true;

      yearSelect.value = '';
      monthSelect.value = '';
      daySelect.innerHTML = '';
      timeSelect.innerHTML = '';

      modelContainer.textContent = `Планировка этажа ${floorNum}`;

      infoPanel.style.display = 'none';

      roomList.querySelectorAll('li').forEach(item => item.classList.remove('selected'));

      checkReserveBtnState();
    });

    yearSelect.addEventListener('change', () => {
      updateDays();
      daySelect.disabled = false;
      checkReserveBtnState();
    });
    monthSelect.addEventListener('change', () => {
      updateDays();
      daySelect.disabled = false;
      checkReserveBtnState();
    });
    daySelect.addEventListener('change', () => {
      fillTimeOptions();
      timeSelect.disabled = false;
      checkReserveBtnState();
    });
    timeSelect.addEventListener('change', () => {
      checkReserveBtnState();
    });

    function timeToMinutes(t) {
      // "HH:MM" → количество минут от 00:00
      const [h, m] = t.split(':').map(Number);
      return h*60 + m;
    }

    function updateRoomOccupancyPanel(roomId, year, month, day) {
      if (!roomId || !year || !month || !day) {
        infoPanel.style.display = 'none';
        return;
      }
      const date = `${year}-${month.toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
      fetch(`/api/reservations?auditorie=${encodeURIComponent(roomId)}&date=${date}`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            infoPanel.innerHTML = `<p style="color:red;">Ошибка: ${data.error}</p>`;
            infoPanel.style.display = 'block';
            return;
          }
          const reservations = data.reservations;
          const intervals = [];
          // Интервалы с шагом 1 час от 9:00 до 22:00
          for(let h=9; h<=22; h++) {
            intervals.push({
              start: `${h.toString().padStart(2,'0')}:00`,
              end: (h===22 ? '22:00' : `${(h+1).toString().padStart(2,'0')}:00`),
              busy: false
            });
          }

          // Функция проверки пересечения между интервалами [start, end]
          function intervalsOverlap(start1, end1, start2, end2) {
            return start1 < end2 && start2 < end1;
          }

          reservations.forEach(r => {
            const resStart = timeToMinutes(r.start);
            const resEnd = timeToMinutes(r.end);
            intervals.forEach(i => {
              const intStart = timeToMinutes(i.start);
              const intEnd = (i.end === '22:00') ? 24*60 : timeToMinutes(i.end);
              if (intervalsOverlap(resStart, resEnd, intStart, intEnd)) {
                i.busy = true;
              }
            });
          });

          let html = `<h3>Информация по аудитории ${roomId} на ${date}</h3>`;
          html += `<p>Занятость с 9:00 до 22:00:</p><div style="max-height: 300px; overflow-y: auto; border: 1px solid #444; padding: 10px; background: #2c2c2c;">`;
          intervals.forEach(i => {
            html += `<p>${i.start} - ${i.end}: ${i.busy ? '<b style="color:#e55353;">Занято</b>' : '<b style="color:#53e58f;">Свободно</b>'}</p>`;
          });
          html += `</div>`;
          infoPanel.innerHTML = html;
          infoPanel.style.display = 'block';
        })
        .catch(err => {
          infoPanel.innerHTML = `<p style="color:red;">Ошибка при загрузке данных</p>`;
          infoPanel.style.display = 'block';
          console.error(err);
        });
    }

    roomList.addEventListener('click', e => {
      const li = e.target.closest('li');
      if (!li) return;

      roomList.querySelectorAll('li').forEach(item => item.classList.remove('selected'));
      li.classList.add('selected');

      const roomId = li.dataset.room;
      const year = yearSelect.value;
      const month = monthSelect.value;
      const day = daySelect.value;

      if(year && month && day) {
        updateRoomOccupancyPanel(roomId, year, month, day);
      } else {
        infoPanel.style.display = 'none';
      }

      checkReserveBtnState();
    });

    function checkReserveBtnState() {
      const floorSelected = floorList.querySelector('li.selected') !== null;
      const yearSelected = yearSelect.value !== '';
      const monthSelected = monthSelect.value !== '';
      const daySelected = daySelect.value !== '';
      const timeSelected = timeSelect.value !== '';
      const roomSelected = roomList.querySelector('li.selected') !== null;

      reserveBtn.disabled = !(floorSelected && yearSelected && monthSelected && daySelected && timeSelected && roomSelected);
    }

    reserveBtn.addEventListener('click', () => {
      const floor = floorList.querySelector('li.selected').dataset.floor;
      const room = roomList.querySelector('li.selected').dataset.room;
      const year = yearSelect.value;
      const month = monthSelect.value.padStart(2, '0');
      const day = daySelect.value.padStart(2, '0');
      const timeRange = timeSelect.value;
      const [startH, endH] = timeRange.split('-');
      const startTime = `${year}-${month}-${day}T${startH}:00`;
      const endTime = `${year}-${month}-${day}T${endH}:00`;

      fetch('{{ url_for("main") }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}'
        },
        body: JSON.stringify({
          action: 'book',
          floor: floor,
          room_id: room,
          start_time: startTime,
          end_time: endTime
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Бронирование успешно создано');
          location.reload();
        } else {
          alert('Ошибка: ' + data.error);
        }
      })
      .catch(err => {
        alert('Ошибка при бронировании');
        console.error(err);
      });
    });

    logoutBtn.addEventListener('click', () => {
      fetch('{{ url_for("main") }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}'
        },
        body: JSON.stringify({action: 'logout'})
      })
      .then(response => response.json())
      .then(data => {
        if (data.success && data.redirect) {
          window.location.href = data.redirect;
        }
      });
    });

    // Инициализация
    fillFloors();
    checkReserveBtnState();
  </script>

</body>
</html>

